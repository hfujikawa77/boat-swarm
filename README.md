# Boat Swarm Control System

対話式ボート群制御システム - 複数のボートを協調制御するためのPythonアプリケーション

## 概要

このプロジェクトは、PyMAVLinkを使用して複数のボート（無人船舶）を同時に制御し、様々なフォーメーションで整列させることができる対話式制御システムです。

## 主な機能

- **複数ボート同時制御**: 最大3台のボートを同時に制御
- **対話式コマンド**: シンプルなコマンドラインインターフェース
- **4方向フォーメーション**: 東西南北の方向に整列可能
- **円形フォーメーション**: 正三角形配置と時計回りの回転
- **自動位置調整**: 1号機を基準に10m間隔で自動整列
- **方位制御**: 到着後は全機北向きに自動調整（円形は中心向き）
- **LOITER制御**: 2,3号機をその場で停止

## システム要件

- Python 3.x
- PyMAVLink
- ArduPilot対応のボート（Rover）

## インストール

```bash
pip install pymavlink
```

## シミュレータの起動方法

### Mission Planner SITLを使用する場合

#### 1. 事前準備（初回のみ）

1. **Mission Plannerのインストール**
   - 最新版のMission Plannerをインストール

2. **Roverシミュレータの初回起動**
   - Mission Plannerを起動
   - 「シミュレーション」タブから「Rover」を選択
   - ArduRover.exeがダウンロード・配置されます
   - 起動確認後、シミュレータを閉じる

3. **パラメータファイルの配置（重要：最初に実行）**
   - `parms\motorboat_flat.parm`を`＜マイドキュメントのパス＞\Mission Planner\sitl\default_params`フォルダにコピー
   - このファイルがないと正しく動作しません

## 使用手順

### 1. シミュレータの起動

```batch
start_boats.bat
```

各ボートは千葉県印西市付近で三角形に配置されます：
- ボート1: 35.877083, 140.339553（方位0°）
- ボート2: 35.877283, 140.339853（方位120°）
- ボート3: 35.876883, 140.339853（方位240°）

### 2. Mission Plannerから接続

#### ポート番号について

各ボートは2つのポートを使用します：
- **Mission Planner接続用**: 5760, 5770, 5780
- **Python/PyMAVLink接続用**: 5762, 5772, 5782

#### 接続手順

1. Mission Plannerを起動
2. 複数機体の同時接続：
   - Mission Plannerの「接続」ボタンを右クリック→「接続オプション」→「TCP」「115200」を選択して「Connect」押下
2. 各ボートに接続（TCP接続）：
   - ボート1: `TCP 127.0.0.1:5760`
   - ボート2: `TCP 127.0.0.1:5770`
   - ボート3: `TCP 127.0.0.1:5780`

### 3. Pythonスクリプトの実行

Mission Plannerで接続確認後、別のコマンドプロンプトで実行：

```bash
python interactive_swarm_control.py
```

### 利用可能なコマンド

- **E** - 東方向に整列（1号機基準で10m間隔、北向き）
- **W** - 西方向に整列（1号機基準で10m間隔、北向き）  
- **S** - 南方向に整列（1号機基準で10m間隔、北向き）
- **N** - 北方向に整列（1号機基準で10m間隔、北向き）
- **C** - 円形フォーメーション（半径15m、全機が中心を向く）
- **R** - 時計回りに30度回転（Cコマンド実行後）
- **T** - 時計回りに120度回転（Cコマンド実行後、正三角形の頂点入れ替え）
- **L** - 2,3号機をLOITERモードに設定（その場で停止）
- **Q** - プログラムを終了
- **シーケンス入力** - 例: `ENWSCRTL` で複数コマンドを連続実行

#### コマンドの実行速度
- **高速実行（1ms間隔）**: R, T, L
- **位置確認付き実行（500ms間隔）**: E, W, S, N, C

**注意**: Mission PlannerとPythonは異なるポートを使用します

## 動作の仕組み

1. **初期接続**: 全ボートに接続し、状態を確認
2. **ARM確認**: 必要に応じてGUIDEDモードとARMを設定
3. **フォーメーション実行**:
   - **直線フォーメーション（E/W/S/N）**:
     - 1号機の現在位置を基準点として取得
     - 指定方向に10m間隔でウェイポイントを計算
     - 2号機と3号機のみ移動（1号機は基準位置を維持）
     - 到着後は全機北向きに方位を調整
   - **円形フォーメーション（C）**:
     - 1号機の現在位置を中心に半径15mの円を設定
     - 3機を120度間隔で配置（正三角形）
     - 全機が円の中心を向く
   - **回転（R/T）**:
     - 円形フォーメーションを維持したまま時計回りに回転
     - R: 30度、T: 120度（正三角形の頂点入れ替え）

## ファイル構成

- `interactive_swarm_control.py` - メインの対話式制御アプリケーション
- `boat_arm_guided.py` - ボート群の基本制御クラス（BoatFleet）
- `start_boats.bat` - 3機のボートシミュレータを起動するバッチファイル
- `prompt.md` - アプリケーション開発用のプロンプト仕様書
- `parms/` - ボート用パラメータファイル

## 注意事項

- 実機での使用前に必ずシミュレーターでテストしてください
- GPS信号が安定している環境で使用してください
- 安全な水域で十分な間隔を確保して使用してください

## ライセンス

[プロジェクトのライセンスを記載]